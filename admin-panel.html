<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fluxi — Admin Panel</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:#0b1020;color:#e6eef8;display:flex;align-items:center;justify-content:center;min-height:100vh}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:28px;border-radius:12px;max-width:720px;width:96%;box-shadow:0 10px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04)}
    h1{margin:0 0 12px 0;font-size:22px}
    p{margin:6px 0;color:#bcd2ee}
    .danger{color:#ff7b7b}
    .actions{display:flex;gap:12px;margin-top:18px}
    button,a.button{background:#2b6df6;color:white;padding:10px 14px;border-radius:8px;text-decoration:none;border:none;cursor:pointer}
    button.secondary,a.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#dbe9ff}
  </style>
</head>
<body>
  <div class="card" id="root">
    <h1>Admin Panel</h1>
    <div id="content">
      <p>Checking session…</p>
    </div>
  </div>

  <script>
    const SESSION_KEY = 'flx_session';

    const decryptToken = (token) => {
      try { return JSON.parse(atob(token)); } catch { return null; }
    };

    // Password hashing (same as login)
    async function hashPassword(password) {
      const enc = new TextEncoder().encode(password);
      const hash = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    function getUsers() { try { return JSON.parse(localStorage.getItem('flx_users') || '[]'); } catch { return []; } }
    function saveUsers(u) { localStorage.setItem('flx_users', JSON.stringify(u)); }

    async function openFluxiHub() {
      try {
        const res = await fetch('fluxi-hub.html');
        if (!res.ok) throw new Error('fetch-failed');
        const html = await res.text();
        const w = window.open('about:blank', '_blank');
        if (!w) { window.location.href = 'fluxi-hub.html'; return; }
        w.document.open();
        w.document.write(html);
        w.document.close();
      } catch (e) {
        window.location.href = 'fluxi-hub.html';
      }
    }

    const showUnauthorized = () => {
      const c = document.getElementById('content');
      c.innerHTML = `
        <p class="danger">You are not authorized to view this page.</p>
        <p>Sign in as an admin from the <a href="index.html" class="secondary button">login page</a>.</p>
      `;
    };

    const renderAdmin = (session) => {
      const c = document.getElementById('content');
      c.innerHTML = `
        <p>Welcome back, <strong>${session.username}</strong>.</p>
        <p>Role: <strong>${session.role}</strong></p>
        <p>Session age: <strong>${Math.floor((Date.now()-session.timestamp)/1000)}s</strong></p>

        <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

        <h3 style="margin-top:8px">Users</h3>
        <div id="user-list" style="margin-top:8px"></div>

        <form id="addUserForm" style="margin-top:14px" onsubmit="return false">
          <div style="display:flex;gap:8px;align-items:center">
            <input id="newUser" placeholder="username" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit">
            <input id="newPass" placeholder="password" type="password" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit">
            <select id="newRole" style="padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
            <button id="addUserBtn" class="button">Add</button>
          </div>
        </form>

          <h3 style="margin-top:18px">Messages</h3>
          <div id="messages-section" style="margin-top:8px">
            <div style="color:#bcd2ee;margin-bottom:8px">Messages submitted by users (visible to admins)</div>
            <div id="message-list">Loading messages…</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="refreshMessages" class="button">Refresh</button>
              <button id="clearMessages" class="secondary">Clear All</button>
            </div>
          </div>

          <div class="actions" style="margin-top:18px">
            <a class="button" id="openFluxiHub" href="fluxi-hub.html">Open Fluxi Hub</a>
            <button id="logout" class="secondary">Logout</button>
          </div>
      `;

      document.getElementById('logout').addEventListener('click', () => {
        sessionStorage.removeItem(SESSION_KEY);
        window.location.href = 'index.html';
      });

      document.getElementById('addUserBtn').addEventListener('click', async () => {
        const uname = document.getElementById('newUser').value.trim();
        const pw = document.getElementById('newPass').value;
        const role = document.getElementById('newRole').value;
        if (!uname || !pw) { alert('username and password required'); return; }

        const users = getUsers();
        if (users.find(u => u.username === uname)) { alert('user already exists'); return; }

        const hash = await hashPassword(pw);
        users.push({ username: uname, passwordHash: hash, role, created: Date.now() });
        saveUsers(users);
        renderUserList(session.username);
        document.getElementById('newUser').value = '';
        document.getElementById('newPass').value = '';
      });

      renderUserList(session.username);
      renderMessages();
      const openBtn = document.getElementById('openFluxiHub');
      if (openBtn) {
        openBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          openFluxiHub();
        });
      }
    };

    // Messages helpers
    function getMessages() { try { return JSON.parse(localStorage.getItem('fluxi_messages') || '[]'); } catch { return []; } }
    function saveMessages(m) { localStorage.setItem('fluxi_messages', JSON.stringify(m)); }

    function renderMessages() {
      const list = document.getElementById('message-list');
      if (!list) return;
      const msgs = getMessages();
      if (!msgs.length) { list.innerHTML = '<div style="color:#9fb">No messages</div>'; return; }

      list.innerHTML = msgs.map((m, idx) => `
        <div style="padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:start">
            <div style="flex:1">
              <div style="font-weight:600">${escapeHtml(m.name)} ${m.email?'<span style="color:#9ad;font-weight:400;margin-left:8px">'+escapeHtml(m.email)+'</span>':''}</div>
              <div style="font-size:12px;color:#bcd2ee">${new Date(m.timestamp).toLocaleString()}</div>
              <div style="margin-top:8px;white-space:pre-wrap;color:#dbe9ff">${escapeHtml(m.message)}</div>
            </div>
            <div style="margin-left:12px;display:flex;flex-direction:column;gap:6px">
              <button class="delete-message" data-idx="${idx}" style="background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:6px;color:inherit">Delete</button>
            </div>
          </div>
        </div>
      `).join('');

      list.querySelectorAll('.delete-message').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.getAttribute('data-idx'));
          if (!confirm('Delete this message?')) return;
          const m = getMessages();
          m.splice(idx,1);
          saveMessages(m);
          renderMessages();
        });
      });
    }

    document.addEventListener('click', (ev) => {
      if (ev.target && ev.target.id === 'refreshMessages') { renderMessages(); }
      if (ev.target && ev.target.id === 'clearMessages') {
        if (!confirm('Clear all messages?')) return;
        saveMessages([]); renderMessages();
      }
    });

    // small helper to avoid HTML injection in admin view
    function escapeHtml(str){ return String(str||'').replace(/[&<>"'`]/g, (s)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[s])); }

    function renderUserList(currentAdmin) {
      const list = document.getElementById('user-list');
      const users = getUsers();
      if (!users.length) { list.innerHTML = '<div class="text-white/40">No users</div>'; return; }

      list.innerHTML = users.map(u => `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)">
          <div>
            <div style="font-weight:600">${u.username} ${u.role==='admin'?'<span style="color:#9ad">(admin)</span>':''}</div>
            <div style="font-size:12px;color:#bcd2ee">created: ${new Date(u.created).toLocaleString()}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            ${u.username !== currentAdmin ? `<button class="delete-user" data-user="${u.username}" style="background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:6px;color:inherit">Delete</button>` : ''}
          </div>
        </div>
      `).join('');

      list.querySelectorAll('.delete-user').forEach(btn => {
        btn.addEventListener('click', () => {
          const uname = btn.getAttribute('data-user');
          if (!confirm(`Delete user ${uname}?`)) return;
          let users = getUsers();
          users = users.filter(u => u.username !== uname);
          saveUsers(users);
          renderUserList(currentAdmin);
        });
      });
    }

    // Validate session and ensure admin
    (function(){
      const token = sessionStorage.getItem(SESSION_KEY);
      if (!token) { showUnauthorized(); return; }

      const session = decryptToken(token);
      if (!session || session.role !== 'admin') { showUnauthorized(); return; }

      // expiry 1 hour (same rule as login)
      if (Date.now() - session.timestamp > 3600000) {
        sessionStorage.removeItem(SESSION_KEY);
        const c = document.getElementById('content');
        c.innerHTML = `<p class="danger">Session expired. Please log in again.</p><div class="actions"><a class="button" href="index.html">Login</a></div>`;
        return;
      }

      // Verify user still exists in store and is admin
      const users = getUsers();
      const me = users.find(u => u.username === session.username && u.role === 'admin');
      if (!me) { showUnauthorized(); return; }

      renderAdmin(session);
    })();
  </script>
  
</body>
</html>
